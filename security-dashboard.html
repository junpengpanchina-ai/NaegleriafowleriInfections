<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰å…¨ç®¡ç†é¢æ¿ | Naegleria fowleri ç½‘ç«™</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* å®‰å…¨é¢æ¿ä¸“ç”¨æ ·å¼ */
        .security-dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .dashboard-title {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dashboard-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin: 0;
        }

        .security-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .stat-card.danger {
            border-left: 5px solid #e74c3c;
        }

        .stat-card.warning {
            border-left: 5px solid #f39c12;
        }

        .stat-card.success {
            border-left: 5px solid #27ae60;
        }

        .stat-card.info {
            border-left: 5px solid #3498db;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 0;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 1.1em;
            color: #7f8c8d;
            margin: 5px 0 0 0;
        }

        .stat-change {
            font-size: 0.9em;
            margin-top: 10px;
        }

        .stat-change.positive {
            color: #e74c3c;
        }

        .stat-change.negative {
            color: #27ae60;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .dashboard-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .threat-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .threat-item {
            padding: 15px;
            border: 1px solid #ecf0f1;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }

        .threat-item:hover {
            background-color: #f8f9fa;
        }

        .threat-item.critical {
            border-left: 4px solid #e74c3c;
            background-color: #fdf2f2;
        }

        .threat-item.high {
            border-left: 4px solid #f39c12;
            background-color: #fefbf3;
        }

        .threat-item.medium {
            border-left: 4px solid #f1c40f;
            background-color: #fffef7;
        }

        .threat-ip {
            font-weight: bold;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
        }

        .threat-score {
            float: right;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .threat-score.critical {
            background: #e74c3c;
            color: white;
        }

        .threat-score.high {
            background: #f39c12;
            color: white;
        }

        .threat-score.medium {
            background: #f1c40f;
            color: #2c3e50;
        }

        .threat-details {
            margin-top: 10px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .activity-log {
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.error {
            color: #e74c3c;
        }

        .log-entry.warn {
            color: #f39c12;
        }

        .log-entry.info {
            color: #3498db;
        }

        .log-timestamp {
            color: #95a5a6;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .control-btn.primary {
            background: #3498db;
            color: white;
        }

        .control-btn.primary:hover {
            background: #2980b9;
        }

        .control-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .control-btn.danger:hover {
            background: #c0392b;
        }

        .control-btn.success {
            background: #27ae60;
            color: white;
        }

        .control-btn.success:hover {
            background: #229954;
        }

        .risk-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .risk-minimal {
            background: #d5f4e6;
            color: #27ae60;
        }

        .risk-low {
            background: #fef9e7;
            color: #f39c12;
        }

        .risk-medium {
            background: #fff3cd;
            color: #e67e22;
        }

        .risk-high {
            background: #f8d7da;
            color: #e74c3c;
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .config-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .config-value {
            color: #7f8c8d;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #bdc3c7;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.active {
            background: #27ae60;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(25px);
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            font-style: italic;
        }

        .alert-banner {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-banner.show {
            display: block;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #27ae60;
            box-shadow: 0 0 5px #27ae60;
        }

        .status-offline {
            background: #e74c3c;
        }

        .status-warning {
            background: #f39c12;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .security-stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .control-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="security-dashboard">
        <!-- å‘Šè­¦æ¨ªå¹… -->
        <div id="alertBanner" class="alert-banner">
            <strong>âš ï¸ å®‰å…¨è­¦å‘Š:</strong> <span id="alertMessage"></span>
        </div>

        <!-- é¢æ¿å¤´éƒ¨ -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                ğŸ›¡ï¸ å®‰å…¨ç®¡ç†é¢æ¿
                <span class="status-indicator status-online" id="systemStatus"></span>
            </h1>
            <p class="dashboard-subtitle">å®æ—¶ç›‘æ§ç½‘ç«™å®‰å…¨çŠ¶æ€ï¼Œç®¡ç†å¨èƒå’Œé…ç½®å®‰å…¨ç­–ç•¥</p>
        </div>

        <!-- å®‰å…¨ç»Ÿè®¡å¡ç‰‡ -->
        <div class="security-stats">
            <div class="stat-card info">
                <div class="stat-number" id="totalRequests">0</div>
                <div class="stat-label">æ€»è¯·æ±‚æ•°</div>
                <div class="stat-change" id="requestsChange">ä»Šæ—¥: +0</div>
            </div>
            
            <div class="stat-card danger">
                <div class="stat-number" id="blockedThreats">0</div>
                <div class="stat-label">å·²é˜»æ­¢å¨èƒ</div>
                <div class="stat-change positive" id="threatsChange">+0 (1å°æ—¶å†…)</div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-number" id="suspiciousIPs">0</div>
                <div class="stat-label">å¯ç–‘IP</div>
                <div class="stat-change" id="ipsChange">æ´»è·ƒç›‘æ§ä¸­</div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-number" id="systemHealth">98%</div>
                <div class="stat-label">ç³»ç»Ÿå¥åº·åº¦</div>
                <div class="stat-change negative">æ‰€æœ‰ç³»ç»Ÿæ­£å¸¸</div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="dashboard-grid">
            <!-- å¨èƒç›‘æ§ -->
            <div class="dashboard-section">
                <h2 class="section-title">
                    ğŸš¨ å®æ—¶å¨èƒç›‘æ§
                    <span class="risk-indicator" id="riskLevel">é£é™©ç­‰çº§: ä½</span>
                </h2>
                
                <div class="threat-list" id="threatList">
                    <div class="loading"></div>
                    <p style="text-align: center; color: #7f8c8d; margin-top: 10px;">æ­£åœ¨åŠ è½½å¨èƒæ•°æ®...</p>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn danger" onclick="blockAllSuspicious()">ğŸš« å°é”æ‰€æœ‰å¯ç–‘IP</button>
                    <button class="control-btn primary" onclick="refreshThreats()">ğŸ”„ åˆ·æ–°å¨èƒåˆ—è¡¨</button>
                    <button class="control-btn success" onclick="exportThreatReport()">ğŸ“Š å¯¼å‡ºå¨èƒæŠ¥å‘Š</button>
                </div>
            </div>

            <!-- ç³»ç»ŸçŠ¶æ€å’Œé…ç½® -->
            <div class="dashboard-section">
                <h2 class="section-title">âš™ï¸ ç³»ç»Ÿé…ç½®</h2>
                
                <div class="config-section">
                    <h3>å®‰å…¨åŠŸèƒ½</h3>
                    <div class="config-item">
                        <span class="config-label">XSSé˜²æŠ¤</span>
                        <div class="toggle-switch active" onclick="toggleConfig('xss')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">SQLæ³¨å…¥é˜²æŠ¤</span>
                        <div class="toggle-switch active" onclick="toggleConfig('sql')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">CSRFé˜²æŠ¤</span>
                        <div class="toggle-switch active" onclick="toggleConfig('csrf')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">è¯„è®ºå®¡æ ¸</span>
                        <div class="toggle-switch active" onclick="toggleConfig('moderation')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">æ•°æ®åŠ å¯†</span>
                        <div class="toggle-switch active" onclick="toggleConfig('encryption')"></div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>ç›‘æ§è®¾ç½®</h3>
                    <div class="config-item">
                        <span class="config-label">å®æ—¶ç›‘æ§</span>
                        <div class="toggle-switch active" onclick="toggleConfig('monitoring')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">è‡ªåŠ¨å¤‡ä»½</span>
                        <div class="toggle-switch active" onclick="toggleConfig('backup')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">å‘Šè­¦é€šçŸ¥</span>
                        <div class="toggle-switch active" onclick="toggleConfig('alerts')"></div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button class="control-btn danger" onclick="resetConfig()">ğŸ”„ é‡ç½®é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- æ´»åŠ¨æ—¥å¿—å’Œå›¾è¡¨ -->
        <div class="dashboard-grid">
            <!-- å®‰å…¨æ´»åŠ¨æ—¥å¿— -->
            <div class="dashboard-section">
                <h2 class="section-title">ğŸ“‹ å®‰å…¨æ´»åŠ¨æ—¥å¿—</h2>
                <div class="activity-log" id="activityLog">
                    <div class="log-entry info">
                        <span class="log-timestamp">[2025-01-21 10:30:15]</span> 
                        <span>INFO: å®‰å…¨ç›‘æ§ç³»ç»Ÿå·²å¯åŠ¨</span>
                    </div>
                    <div class="log-entry warn">
                        <span class="log-timestamp">[2025-01-21 10:31:22]</span> 
                        <span>WARN: æ£€æµ‹åˆ°å¯ç–‘IPæ´»åŠ¨ 192.168.1.100</span>
                    </div>
                    <div class="log-entry error">
                        <span class="log-timestamp">[2025-01-21 10:32:45]</span> 
                        <span>ERROR: XSSæ”»å‡»å°è¯•è¢«é˜»æ­¢</span>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn primary" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                    <button class="control-btn success" onclick="exportLogs()">ğŸ“¥ å¯¼å‡ºæ—¥å¿—</button>
                </div>
            </div>

            <!-- å®‰å…¨è¶‹åŠ¿å›¾è¡¨ -->
            <div class="dashboard-section">
                <h2 class="section-title">ğŸ“ˆ å®‰å…¨è¶‹åŠ¿åˆ†æ</h2>
                <div class="chart-container" id="securityChart">
                    ğŸ“Š å®‰å…¨è¶‹åŠ¿å›¾è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º
                    <br><small>ï¼ˆéœ€è¦å›¾è¡¨åº“æ”¯æŒï¼‰</small>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn primary" onclick="generateReport()">ğŸ“Š ç”ŸæˆæŠ¥å‘Š</button>
                    <button class="control-btn success" onclick="scheduleReport()">â° å®šæ—¶æŠ¥å‘Š</button>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ“ä½œé¢æ¿ -->
        <div class="dashboard-section">
            <h2 class="section-title">âš¡ å¿«é€Ÿæ“ä½œ</h2>
            <div class="control-buttons">
                <button class="control-btn primary" onclick="runSecurityScan()">ğŸ” æ‰§è¡Œå®‰å…¨æ‰«æ</button>
                <button class="control-btn success" onclick="createBackup()">ğŸ’¾ åˆ›å»ºå®‰å…¨å¤‡ä»½</button>
                <button class="control-btn warning" onclick="testSecurity()">ğŸ§ª å®‰å…¨æµ‹è¯•</button>
                <button class="control-btn danger" onclick="emergencyLockdown()">ğŸš¨ ç´§æ€¥é”å®š</button>
                <a href="index.html" class="control-btn primary">ğŸ  è¿”å›é¦–é¡µ</a>
                <a href="admin.html" class="control-btn primary">âš™ï¸ ç®¡ç†åå°</a>
            </div>
        </div>
    </div>

    <script>
        // å®‰å…¨é¢æ¿JavaScript
        class SecurityDashboard {
            constructor() {
                this.updateInterval = 5000; // 5ç§’æ›´æ–°ä¸€æ¬¡
                this.securityData = {
                    totalRequests: 0,
                    blockedThreats: 0,
                    suspiciousIPs: 0,
                    systemHealth: 98,
                    riskLevel: 'MINIMAL',
                    threats: [],
                    logs: []
                };
                
                this.init();
            }

            init() {
                this.loadSecurityData();
                this.startRealTimeUpdates();
                this.setupEventListeners();
                console.log('ğŸ›¡ï¸ å®‰å…¨ç®¡ç†é¢æ¿å·²åˆå§‹åŒ–');
            }

            // åŠ è½½å®‰å…¨æ•°æ®
            async loadSecurityData() {
                try {
                    // æ¨¡æ‹Ÿä»APIåŠ è½½æ•°æ®
                    this.securityData = {
                        totalRequests: Math.floor(Math.random() * 10000) + 5000,
                        blockedThreats: Math.floor(Math.random() * 50) + 10,
                        suspiciousIPs: Math.floor(Math.random() * 20) + 5,
                        systemHealth: 95 + Math.floor(Math.random() * 5),
                        riskLevel: ['MINIMAL', 'LOW', 'MEDIUM'][Math.floor(Math.random() * 3)],
                        threats: this.generateMockThreats(),
                        logs: this.generateMockLogs()
                    };
                    
                    this.updateDashboard();
                } catch (error) {
                    console.error('åŠ è½½å®‰å…¨æ•°æ®å¤±è´¥:', error);
                    this.showAlert('æ— æ³•åŠ è½½å®‰å…¨æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            }

            // ç”Ÿæˆæ¨¡æ‹Ÿå¨èƒæ•°æ®
            generateMockThreats() {
                const threats = [];
                const ips = ['192.168.1.100', '10.0.0.50', '172.16.0.25', '203.0.113.10'];
                const types = ['XSSæ”»å‡»', 'SQLæ³¨å…¥', 'CSRFæ”»å‡»', 'åƒåœ¾è¯„è®º', 'æš´åŠ›ç ´è§£'];
                
                for (let i = 0; i < Math.floor(Math.random() * 8) + 2; i++) {
                    const score = Math.floor(Math.random() * 100);
                    threats.push({
                        ip: ips[Math.floor(Math.random() * ips.length)],
                        type: types[Math.floor(Math.random() * types.length)],
                        score: score,
                        severity: score > 80 ? 'critical' : score > 60 ? 'high' : 'medium',
                        timestamp: new Date(Date.now() - Math.random() * 3600000).toISOString(),
                        blocked: Math.random() > 0.5
                    });
                }
                
                return threats.sort((a, b) => b.score - a.score);
            }

            // ç”Ÿæˆæ¨¡æ‹Ÿæ—¥å¿—æ•°æ®
            generateMockLogs() {
                const logs = [];
                const events = [
                    { level: 'info', message: 'ç”¨æˆ·ç™»å½•æˆåŠŸ' },
                    { level: 'warn', message: 'æ£€æµ‹åˆ°å¼‚å¸¸è¯·æ±‚é¢‘ç‡' },
                    { level: 'error', message: 'XSSæ”»å‡»å°è¯•è¢«é˜»æ­¢' },
                    { level: 'info', message: 'å®‰å…¨å¤‡ä»½åˆ›å»ºå®Œæˆ' },
                    { level: 'warn', message: 'å¯ç–‘IPè¢«æ ‡è®°' },
                    { level: 'error', message: 'SQLæ³¨å…¥æ”»å‡»è¢«æ‹¦æˆª' }
                ];
                
                for (let i = 0; i < 10; i++) {
                    const event = events[Math.floor(Math.random() * events.length)];
                    logs.push({
                        timestamp: new Date(Date.now() - i * 60000).toISOString(),
                        level: event.level,
                        message: event.message
                    });
                }
                
                return logs;
            }

            // æ›´æ–°é¢æ¿æ˜¾ç¤º
            updateDashboard() {
                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                document.getElementById('totalRequests').textContent = this.securityData.totalRequests.toLocaleString();
                document.getElementById('blockedThreats').textContent = this.securityData.blockedThreats;
                document.getElementById('suspiciousIPs').textContent = this.securityData.suspiciousIPs;
                document.getElementById('systemHealth').textContent = this.securityData.systemHealth + '%';

                // æ›´æ–°é£é™©ç­‰çº§
                const riskElement = document.getElementById('riskLevel');
                const riskMap = {
                    'MINIMAL': { text: 'é£é™©ç­‰çº§: æä½', class: 'risk-minimal' },
                    'LOW': { text: 'é£é™©ç­‰çº§: ä½', class: 'risk-low' },
                    'MEDIUM': { text: 'é£é™©ç­‰çº§: ä¸­', class: 'risk-medium' },
                    'HIGH': { text: 'é£é™©ç­‰çº§: é«˜', class: 'risk-high' }
                };
                
                const risk = riskMap[this.securityData.riskLevel];
                riskElement.textContent = risk.text;
                riskElement.className = 'risk-indicator ' + risk.class;

                // æ›´æ–°å¨èƒåˆ—è¡¨
                this.updateThreatList();
                
                // æ›´æ–°æ´»åŠ¨æ—¥å¿—
                this.updateActivityLog();
                
                // æ›´æ–°ç³»ç»ŸçŠ¶æ€
                this.updateSystemStatus();
            }

            // æ›´æ–°å¨èƒåˆ—è¡¨
            updateThreatList() {
                this.loadAttackersData();
            }

            // åŠ è½½æ”»å‡»è€…æ•°æ®
            async loadAttackersData() {
                try {
                    const response = await fetch('/api/security/attackers');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.displayAttackers(result.data);
                    } else {
                        console.error('åŠ è½½æ”»å‡»è€…æ•°æ®å¤±è´¥:', result.error);
                        this.displayMockThreats();
                    }
                } catch (error) {
                    console.error('åŠ è½½æ”»å‡»è€…æ•°æ®å¤±è´¥:', error);
                    this.displayMockThreats();
                }
            }

            // æ˜¾ç¤ºæ”»å‡»è€…ä¿¡æ¯
            displayAttackers(attackers) {
                const threatList = document.getElementById('threatList');
                
                if (attackers.length === 0) {
                    threatList.innerHTML = '<p style="text-align: center; color: #27ae60; padding: 40px;">ğŸ‰ å½“å‰æ— æ´»è·ƒå¨èƒ</p>';
                    return;
                }
                
                const attackersHtml = attackers.slice(0, 10).map(attacker => `
                    <div class="threat-item ${attacker.threatLevel.toLowerCase()}">
                        <div>
                            <span class="threat-ip">${attacker.ip}</span>
                            <span class="threat-score ${attacker.threatLevel.toLowerCase()}">${attacker.attackCount}</span>
                            ${attacker.geoLocation ? `<span style="font-size: 0.8em; color: #666; margin-left: 10px;">ğŸ“ ${attacker.geoLocation.country}</span>` : ''}
                        </div>
                        <div class="threat-details">
                            <strong>å¨èƒç­‰çº§: ${attacker.threatLevel}</strong> - 
                            æ”»å‡»ç±»å‹: ${Array.from(attacker.attackTypes).join(', ')} - 
                            ${attacker.isBlocked ? 'ğŸš« å·²å°é”' : 'ğŸ‘ï¸ ç›‘æ§ä¸­'} - 
                            æœ€åæ´»åŠ¨: ${new Date(attacker.lastSeen).toLocaleString()}
                        </div>
                        <div class="threat-details" style="margin-top: 5px; font-size: 0.85em;">
                            é¦–æ¬¡å‘ç°: ${new Date(attacker.firstSeen).toLocaleString()} | 
                            èœœç½å‘½ä¸­: ${attacker.honeypotHits}æ¬¡ | 
                            è¯æ®: ${attacker.evidence.length}æ¡
                        </div>
                        <div style="margin-top: 10px;">
                            ${!attacker.isBlocked ? `
                                <button class="control-btn danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="blockIP('${attacker.ip}')">
                                    ğŸš« å°é”IP
                                </button>
                            ` : `
                                <button class="control-btn success" style="padding: 5px 10px; font-size: 0.8em;" onclick="unblockIP('${attacker.ip}')">
                                    âœ… è§£é™¤å°é”
                                </button>
                            `}
                            <button class="control-btn primary" style="padding: 5px 10px; font-size: 0.8em;" onclick="viewAttackerDetails('${attacker.ip}')">
                                ğŸ“‹ è¯¦ç»†ä¿¡æ¯
                            </button>
                            <button class="control-btn warning" style="padding: 5px 10px; font-size: 0.8em;" onclick="viewEvidence('${attacker.ip}')">
                                ğŸ” æŸ¥çœ‹è¯æ®
                            </button>
                        </div>
                    </div>
                `).join('');
                
                threatList.innerHTML = attackersHtml;
            }

            // æ˜¾ç¤ºæ¨¡æ‹Ÿå¨èƒï¼ˆå¤‡ç”¨ï¼‰
            displayMockThreats() {
                const threatList = document.getElementById('threatList');
                
                if (this.securityData.threats.length === 0) {
                    threatList.innerHTML = '<p style="text-align: center; color: #27ae60; padding: 40px;">ğŸ‰ å½“å‰æ— æ´»è·ƒå¨èƒ</p>';
                    return;
                }
                
                const threatsHtml = this.securityData.threats.map(threat => `
                    <div class="threat-item ${threat.severity}">
                        <div>
                            <span class="threat-ip">${threat.ip}</span>
                            <span class="threat-score ${threat.severity}">${threat.score}</span>
                        </div>
                        <div class="threat-details">
                            <strong>${threat.type}</strong> - 
                            ${threat.blocked ? 'å·²é˜»æ­¢' : 'ç›‘æ§ä¸­'} - 
                            ${new Date(threat.timestamp).toLocaleTimeString()}
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="control-btn danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="blockIP('${threat.ip}')">
                                ğŸš« å°é”IP
                            </button>
                            <button class="control-btn primary" style="padding: 5px 10px; font-size: 0.8em;" onclick="viewThreatDetails('${threat.ip}')">
                                ğŸ“‹ è¯¦æƒ…
                            </button>
                        </div>
                    </div>
                `).join('');
                
                threatList.innerHTML = threatsHtml;
            }

            // æ›´æ–°æ´»åŠ¨æ—¥å¿—
            updateActivityLog() {
                const activityLog = document.getElementById('activityLog');
                
                const logsHtml = this.securityData.logs.map(log => `
                    <div class="log-entry ${log.level}">
                        <span class="log-timestamp">[${new Date(log.timestamp).toLocaleString()}]</span>
                        <span>${log.level.toUpperCase()}: ${log.message}</span>
                    </div>
                `).join('');
                
                activityLog.innerHTML = logsHtml;
                
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                activityLog.scrollTop = activityLog.scrollHeight;
            }

            // æ›´æ–°ç³»ç»ŸçŠ¶æ€
            updateSystemStatus() {
                const statusElement = document.getElementById('systemStatus');
                const health = this.securityData.systemHealth;
                
                if (health >= 95) {
                    statusElement.className = 'status-indicator status-online';
                } else if (health >= 80) {
                    statusElement.className = 'status-indicator status-warning';
                } else {
                    statusElement.className = 'status-indicator status-offline';
                }
            }

            // å¼€å§‹å®æ—¶æ›´æ–°
            startRealTimeUpdates() {
                setInterval(() => {
                    this.loadSecurityData();
                }, this.updateInterval);
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners() {
                // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶æš‚åœ/æ¢å¤æ›´æ–°
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        console.log('â¸ï¸ é¢æ¿æ›´æ–°å·²æš‚åœ');
                    } else {
                        console.log('â–¶ï¸ é¢æ¿æ›´æ–°å·²æ¢å¤');
                        this.loadSecurityData();
                    }
                });
            }

            // æ˜¾ç¤ºå‘Šè­¦
            showAlert(message, type = 'error') {
                const alertBanner = document.getElementById('alertBanner');
                const alertMessage = document.getElementById('alertMessage');
                
                alertMessage.textContent = message;
                alertBanner.className = 'alert-banner show';
                
                // 5ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    alertBanner.className = 'alert-banner';
                }, 5000);
            }
        }

        // åˆå§‹åŒ–å®‰å…¨é¢æ¿
        let securityDashboard;
        document.addEventListener('DOMContentLoaded', () => {
            securityDashboard = new SecurityDashboard();
        });

        // å…¨å±€å‡½æ•°
        function toggleConfig(configName) {
            const toggles = document.querySelectorAll('.toggle-switch');
            // è¿™é‡Œåº”è¯¥å®ç°çœŸå®çš„é…ç½®åˆ‡æ¢é€»è¾‘
            console.log(`åˆ‡æ¢é…ç½®: ${configName}`);
        }

        async function blockIP(ip) {
            if (confirm(`ç¡®å®šè¦å°é”IPåœ°å€ ${ip} å—ï¼Ÿ`)) {
                try {
                    const response = await fetch('/api/security/block-ip', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ip: ip,
                            reason: 'ç®¡ç†å‘˜æ‰‹åŠ¨å°é”'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        securityDashboard.showAlert(`IP ${ip} å·²è¢«å°é”`, 'success');
                        securityDashboard.loadSecurityData(); // åˆ·æ–°æ•°æ®
                    } else {
                        securityDashboard.showAlert(`å°é”å¤±è´¥: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('å°é”IPå¤±è´¥:', error);
                    securityDashboard.showAlert('å°é”æ“ä½œå¤±è´¥', 'error');
                }
            }
        }

        async function unblockIP(ip) {
            if (confirm(`ç¡®å®šè¦è§£é™¤å°é”IPåœ°å€ ${ip} å—ï¼Ÿ`)) {
                try {
                    const response = await fetch('/api/security/unblock-ip', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ ip: ip })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        securityDashboard.showAlert(`IP ${ip} å·²è§£é™¤å°é”`, 'success');
                        securityDashboard.loadSecurityData(); // åˆ·æ–°æ•°æ®
                    } else {
                        securityDashboard.showAlert(`è§£é™¤å°é”å¤±è´¥: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('è§£é™¤å°é”å¤±è´¥:', error);
                    securityDashboard.showAlert('è§£é™¤å°é”æ“ä½œå¤±è´¥', 'error');
                }
            }
        }

        async function viewAttackerDetails(ip) {
            try {
                const response = await fetch(`/api/security/attacker/${ip}`);
                const result = await response.json();
                
                if (result.success) {
                    const attacker = result.data;
                    const detailsHtml = `
                        <div style="max-width: 600px; max-height: 500px; overflow-y: auto;">
                            <h3>ğŸ•µï¸ æ”»å‡»è€…è¯¦ç»†ä¿¡æ¯</h3>
                            <p><strong>IPåœ°å€:</strong> ${attacker.ip}</p>
                            <p><strong>å¨èƒç­‰çº§:</strong> <span style="color: ${getThreatColor(attacker.threatLevel)}">${attacker.threatLevel}</span></p>
                            <p><strong>æ”»å‡»æ¬¡æ•°:</strong> ${attacker.attackCount}</p>
                            <p><strong>é¦–æ¬¡å‘ç°:</strong> ${new Date(attacker.firstSeen).toLocaleString()}</p>
                            <p><strong>æœ€åæ´»åŠ¨:</strong> ${new Date(attacker.lastSeen).toLocaleString()}</p>
                            <p><strong>èœœç½å‘½ä¸­:</strong> ${attacker.honeypotHits}æ¬¡</p>
                            <p><strong>å°é”çŠ¶æ€:</strong> ${attacker.isBlocked ? 'ğŸš« å·²å°é”' : 'ğŸ‘ï¸ ç›‘æ§ä¸­'}</p>
                            
                            ${attacker.geoLocation ? `
                                <h4>ğŸ“ åœ°ç†ä½ç½®ä¿¡æ¯</h4>
                                <p><strong>å›½å®¶:</strong> ${attacker.geoLocation.country}</p>
                                <p><strong>åŸå¸‚:</strong> ${attacker.geoLocation.city}</p>
                                <p><strong>ISP:</strong> ${attacker.geoLocation.isp}</p>
                                <p><strong>ç»„ç»‡:</strong> ${attacker.geoLocation.org}</p>
                            ` : ''}
                            
                            <h4>ğŸ¯ æ”»å‡»ç±»å‹</h4>
                            <p>${Array.from(attacker.attackTypes).join(', ')}</p>
                            
                            <h4>ğŸ–¥ï¸ ç”¨æˆ·ä»£ç†</h4>
                            <div style="max-height: 100px; overflow-y: auto; font-size: 0.8em; background: #f5f5f5; padding: 10px;">
                                ${Array.from(attacker.userAgents).map(ua => `<p>${ua}</p>`).join('')}
                            </div>
                            
                            <h4>ğŸ”— è®¿é—®è·¯å¾„</h4>
                            <div style="max-height: 100px; overflow-y: auto; font-size: 0.8em; background: #f5f5f5; padding: 10px;">
                                ${Array.from(attacker.requestedPaths).map(path => `<p>${path}</p>`).join('')}
                            </div>
                        </div>
                    `;
                    
                    showModal('æ”»å‡»è€…è¯¦æƒ…', detailsHtml);
                } else {
                    securityDashboard.showAlert('è·å–æ”»å‡»è€…è¯¦æƒ…å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è·å–æ”»å‡»è€…è¯¦æƒ…å¤±è´¥:', error);
                securityDashboard.showAlert('è·å–æ”»å‡»è€…è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        function viewEvidence(ip) {
            // æ˜¾ç¤ºè¯æ®è¯¦æƒ…
            showModal('è¯æ®è¯¦æƒ…', `
                <div>
                    <h3>ğŸ“‹ æ”»å‡»è¯æ®</h3>
                    <p>æ­£åœ¨åŠ è½½IP ${ip} çš„æ”»å‡»è¯æ®...</p>
                    <p>æ­¤åŠŸèƒ½å°†æ˜¾ç¤º:</p>
                    <ul>
                        <li>æ”»å‡»è½½è·å’Œæ¨¡å¼</li>
                        <li>è¯·æ±‚å¤´å’Œå‚æ•°</li>
                        <li>æ—¶é—´æˆ³å’Œé¢‘ç‡åˆ†æ</li>
                        <li>æ•°å­—æŒ‡çº¹ä¿¡æ¯</li>
                        <li>æ³•å¾‹è¯æ®æŠ¥å‘Š</li>
                    </ul>
                </div>
            `);
        }

        function getThreatColor(level) {
            const colors = {
                'CRITICAL': '#e74c3c',
                'HIGH': '#f39c12',
                'MEDIUM': '#f1c40f',
                'LOW': '#27ae60'
            };
            return colors[level] || '#666';
        }

        function showModal(title, content) {
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    max-width: 80%;
                    max-height: 80%;
                    overflow-y: auto;
                    position: relative;
                ">
                    <button onclick="this.closest('.modal').remove()" style="
                        position: absolute;
                        top: 10px;
                        right: 15px;
                        background: none;
                        border: none;
                        font-size: 20px;
                        cursor: pointer;
                        color: #666;
                    ">&times;</button>
                    <h2>${title}</h2>
                    ${content}
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function viewThreatDetails(ip) {
            viewAttackerDetails(ip);
        }

        function blockAllSuspicious() {
            if (confirm('ç¡®å®šè¦å°é”æ‰€æœ‰å¯ç–‘IPå—ï¼Ÿè¿™æ˜¯ä¸€ä¸ªå±é™©æ“ä½œï¼')) {
                console.log('å°é”æ‰€æœ‰å¯ç–‘IP');
                securityDashboard.showAlert('æ‰€æœ‰å¯ç–‘IPå·²è¢«å°é”', 'success');
            }
        }

        function refreshThreats() {
            console.log('åˆ·æ–°å¨èƒåˆ—è¡¨');
            securityDashboard.loadSecurityData();
        }

        function exportThreatReport() {
            console.log('å¯¼å‡ºå¨èƒæŠ¥å‘Š');
            securityDashboard.showAlert('å¨èƒæŠ¥å‘Šå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­', 'info');
        }

        function saveConfig() {
            console.log('ä¿å­˜é…ç½®');
            securityDashboard.showAlert('é…ç½®å·²ä¿å­˜', 'success');
        }

        function resetConfig() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰é…ç½®å—ï¼Ÿ')) {
                console.log('é‡ç½®é…ç½®');
                securityDashboard.showAlert('é…ç½®å·²é‡ç½®', 'success');
            }
        }

        function clearLogs() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿ')) {
                document.getElementById('activityLog').innerHTML = '<div class="log-entry info"><span class="log-timestamp">[' + new Date().toLocaleString() + ']</span> <span>INFO: æ—¥å¿—å·²æ¸…ç©º</span></div>';
            }
        }

        function exportLogs() {
            console.log('å¯¼å‡ºæ—¥å¿—');
            securityDashboard.showAlert('æ—¥å¿—å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­', 'info');
        }

        function generateReport() {
            console.log('ç”ŸæˆæŠ¥å‘Š');
            securityDashboard.showAlert('æŠ¥å‘Šç”ŸæˆåŠŸèƒ½å¼€å‘ä¸­', 'info');
        }

        function scheduleReport() {
            console.log('å®šæ—¶æŠ¥å‘Š');
            securityDashboard.showAlert('å®šæ—¶æŠ¥å‘ŠåŠŸèƒ½å¼€å‘ä¸­', 'info');
        }

        function runSecurityScan() {
            console.log('æ‰§è¡Œå®‰å…¨æ‰«æ');
            securityDashboard.showAlert('å®‰å…¨æ‰«æå·²å¯åŠ¨', 'info');
        }

        function createBackup() {
            console.log('åˆ›å»ºå®‰å…¨å¤‡ä»½');
            securityDashboard.showAlert('å®‰å…¨å¤‡ä»½å·²åˆ›å»º', 'success');
        }

        function testSecurity() {
            console.log('å®‰å…¨æµ‹è¯•');
            securityDashboard.showAlert('å®‰å…¨æµ‹è¯•å·²å¯åŠ¨', 'info');
        }

        function emergencyLockdown() {
            if (confirm('ç¡®å®šè¦å¯åŠ¨ç´§æ€¥é”å®šå—ï¼Ÿè¿™å°†é˜»æ­¢æ‰€æœ‰è®¿é—®ï¼')) {
                console.log('ç´§æ€¥é”å®š');
                securityDashboard.showAlert('ç´§æ€¥é”å®šå·²æ¿€æ´»', 'error');
            }
        }
    </script>
</body>
</html> 