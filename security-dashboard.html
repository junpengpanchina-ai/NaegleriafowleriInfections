<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安全管理面板 | Naegleria fowleri 网站</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 安全面板专用样式 */
        .security-dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .dashboard-title {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dashboard-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin: 0;
        }

        .security-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .stat-card.danger {
            border-left: 5px solid #e74c3c;
        }

        .stat-card.warning {
            border-left: 5px solid #f39c12;
        }

        .stat-card.success {
            border-left: 5px solid #27ae60;
        }

        .stat-card.info {
            border-left: 5px solid #3498db;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 0;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 1.1em;
            color: #7f8c8d;
            margin: 5px 0 0 0;
        }

        .stat-change {
            font-size: 0.9em;
            margin-top: 10px;
        }

        .stat-change.positive {
            color: #e74c3c;
        }

        .stat-change.negative {
            color: #27ae60;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .dashboard-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .threat-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .threat-item {
            padding: 15px;
            border: 1px solid #ecf0f1;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }

        .threat-item:hover {
            background-color: #f8f9fa;
        }

        .threat-item.critical {
            border-left: 4px solid #e74c3c;
            background-color: #fdf2f2;
        }

        .threat-item.high {
            border-left: 4px solid #f39c12;
            background-color: #fefbf3;
        }

        .threat-item.medium {
            border-left: 4px solid #f1c40f;
            background-color: #fffef7;
        }

        .threat-ip {
            font-weight: bold;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
        }

        .threat-score {
            float: right;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .threat-score.critical {
            background: #e74c3c;
            color: white;
        }

        .threat-score.high {
            background: #f39c12;
            color: white;
        }

        .threat-score.medium {
            background: #f1c40f;
            color: #2c3e50;
        }

        .threat-details {
            margin-top: 10px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .activity-log {
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry.error {
            color: #e74c3c;
        }

        .log-entry.warn {
            color: #f39c12;
        }

        .log-entry.info {
            color: #3498db;
        }

        .log-timestamp {
            color: #95a5a6;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .control-btn.primary {
            background: #3498db;
            color: white;
        }

        .control-btn.primary:hover {
            background: #2980b9;
        }

        .control-btn.danger {
            background: #e74c3c;
            color: white;
        }

        .control-btn.danger:hover {
            background: #c0392b;
        }

        .control-btn.success {
            background: #27ae60;
            color: white;
        }

        .control-btn.success:hover {
            background: #229954;
        }

        .risk-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .risk-minimal {
            background: #d5f4e6;
            color: #27ae60;
        }

        .risk-low {
            background: #fef9e7;
            color: #f39c12;
        }

        .risk-medium {
            background: #fff3cd;
            color: #e67e22;
        }

        .risk-high {
            background: #f8d7da;
            color: #e74c3c;
        }

        .config-section {
            margin-bottom: 25px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .config-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .config-value {
            color: #7f8c8d;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
            background: #bdc3c7;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .toggle-switch.active {
            background: #27ae60;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 21px;
            height: 21px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(25px);
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
            background: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            font-style: italic;
        }

        .alert-banner {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-banner.show {
            display: block;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #27ae60;
            box-shadow: 0 0 5px #27ae60;
        }

        .status-offline {
            background: #e74c3c;
        }

        .status-warning {
            background: #f39c12;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .security-stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .control-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="security-dashboard">
        <!-- 告警横幅 -->
        <div id="alertBanner" class="alert-banner">
            <strong>⚠️ 安全警告:</strong> <span id="alertMessage"></span>
        </div>

        <!-- 面板头部 -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                🛡️ 安全管理面板
                <span class="status-indicator status-online" id="systemStatus"></span>
            </h1>
            <p class="dashboard-subtitle">实时监控网站安全状态，管理威胁和配置安全策略</p>
        </div>

        <!-- 安全统计卡片 -->
        <div class="security-stats">
            <div class="stat-card info">
                <div class="stat-number" id="totalRequests">0</div>
                <div class="stat-label">总请求数</div>
                <div class="stat-change" id="requestsChange">今日: +0</div>
            </div>
            
            <div class="stat-card danger">
                <div class="stat-number" id="blockedThreats">0</div>
                <div class="stat-label">已阻止威胁</div>
                <div class="stat-change positive" id="threatsChange">+0 (1小时内)</div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-number" id="suspiciousIPs">0</div>
                <div class="stat-label">可疑IP</div>
                <div class="stat-change" id="ipsChange">活跃监控中</div>
            </div>
            
            <div class="stat-card success">
                <div class="stat-number" id="systemHealth">98%</div>
                <div class="stat-label">系统健康度</div>
                <div class="stat-change negative">所有系统正常</div>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="dashboard-grid">
            <!-- 威胁监控 -->
            <div class="dashboard-section">
                <h2 class="section-title">
                    🚨 实时威胁监控
                    <span class="risk-indicator" id="riskLevel">风险等级: 低</span>
                </h2>
                
                <div class="threat-list" id="threatList">
                    <div class="loading"></div>
                    <p style="text-align: center; color: #7f8c8d; margin-top: 10px;">正在加载威胁数据...</p>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn danger" onclick="blockAllSuspicious()">🚫 封锁所有可疑IP</button>
                    <button class="control-btn primary" onclick="refreshThreats()">🔄 刷新威胁列表</button>
                    <button class="control-btn success" onclick="exportThreatReport()">📊 导出威胁报告</button>
                </div>
            </div>

            <!-- 系统状态和配置 -->
            <div class="dashboard-section">
                <h2 class="section-title">⚙️ 系统配置</h2>
                
                <div class="config-section">
                    <h3>安全功能</h3>
                    <div class="config-item">
                        <span class="config-label">XSS防护</span>
                        <div class="toggle-switch active" onclick="toggleConfig('xss')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">SQL注入防护</span>
                        <div class="toggle-switch active" onclick="toggleConfig('sql')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">CSRF防护</span>
                        <div class="toggle-switch active" onclick="toggleConfig('csrf')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">评论审核</span>
                        <div class="toggle-switch active" onclick="toggleConfig('moderation')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">数据加密</span>
                        <div class="toggle-switch active" onclick="toggleConfig('encryption')"></div>
                    </div>
                </div>
                
                <div class="config-section">
                    <h3>监控设置</h3>
                    <div class="config-item">
                        <span class="config-label">实时监控</span>
                        <div class="toggle-switch active" onclick="toggleConfig('monitoring')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">自动备份</span>
                        <div class="toggle-switch active" onclick="toggleConfig('backup')"></div>
                    </div>
                    <div class="config-item">
                        <span class="config-label">告警通知</span>
                        <div class="toggle-switch active" onclick="toggleConfig('alerts')"></div>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn primary" onclick="saveConfig()">💾 保存配置</button>
                    <button class="control-btn danger" onclick="resetConfig()">🔄 重置配置</button>
                </div>
            </div>
        </div>

        <!-- 活动日志和图表 -->
        <div class="dashboard-grid">
            <!-- 安全活动日志 -->
            <div class="dashboard-section">
                <h2 class="section-title">📋 安全活动日志</h2>
                <div class="activity-log" id="activityLog">
                    <div class="log-entry info">
                        <span class="log-timestamp">[2025-01-21 10:30:15]</span> 
                        <span>INFO: 安全监控系统已启动</span>
                    </div>
                    <div class="log-entry warn">
                        <span class="log-timestamp">[2025-01-21 10:31:22]</span> 
                        <span>WARN: 检测到可疑IP活动 192.168.1.100</span>
                    </div>
                    <div class="log-entry error">
                        <span class="log-timestamp">[2025-01-21 10:32:45]</span> 
                        <span>ERROR: XSS攻击尝试被阻止</span>
                    </div>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn primary" onclick="clearLogs()">🗑️ 清空日志</button>
                    <button class="control-btn success" onclick="exportLogs()">📥 导出日志</button>
                </div>
            </div>

            <!-- 安全趋势图表 -->
            <div class="dashboard-section">
                <h2 class="section-title">📈 安全趋势分析</h2>
                <div class="chart-container" id="securityChart">
                    📊 安全趋势图表将在这里显示
                    <br><small>（需要图表库支持）</small>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn primary" onclick="generateReport()">📊 生成报告</button>
                    <button class="control-btn success" onclick="scheduleReport()">⏰ 定时报告</button>
                </div>
            </div>
        </div>

        <!-- 快速操作面板 -->
        <div class="dashboard-section">
            <h2 class="section-title">⚡ 快速操作</h2>
            <div class="control-buttons">
                <button class="control-btn primary" onclick="runSecurityScan()">🔍 执行安全扫描</button>
                <button class="control-btn success" onclick="createBackup()">💾 创建安全备份</button>
                <button class="control-btn warning" onclick="testSecurity()">🧪 安全测试</button>
                <button class="control-btn danger" onclick="emergencyLockdown()">🚨 紧急锁定</button>
                <a href="index.html" class="control-btn primary">🏠 返回首页</a>
                <a href="admin.html" class="control-btn primary">⚙️ 管理后台</a>
            </div>
        </div>
    </div>

    <script>
        // 安全面板JavaScript
        class SecurityDashboard {
            constructor() {
                this.updateInterval = 5000; // 5秒更新一次
                this.securityData = {
                    totalRequests: 0,
                    blockedThreats: 0,
                    suspiciousIPs: 0,
                    systemHealth: 98,
                    riskLevel: 'MINIMAL',
                    threats: [],
                    logs: []
                };
                
                this.init();
            }

            init() {
                this.loadSecurityData();
                this.startRealTimeUpdates();
                this.setupEventListeners();
                console.log('🛡️ 安全管理面板已初始化');
            }

            // 加载安全数据
            async loadSecurityData() {
                try {
                    // 模拟从API加载数据
                    this.securityData = {
                        totalRequests: Math.floor(Math.random() * 10000) + 5000,
                        blockedThreats: Math.floor(Math.random() * 50) + 10,
                        suspiciousIPs: Math.floor(Math.random() * 20) + 5,
                        systemHealth: 95 + Math.floor(Math.random() * 5),
                        riskLevel: ['MINIMAL', 'LOW', 'MEDIUM'][Math.floor(Math.random() * 3)],
                        threats: this.generateMockThreats(),
                        logs: this.generateMockLogs()
                    };
                    
                    this.updateDashboard();
                } catch (error) {
                    console.error('加载安全数据失败:', error);
                    this.showAlert('无法加载安全数据，请检查网络连接');
                }
            }

            // 生成模拟威胁数据
            generateMockThreats() {
                const threats = [];
                const ips = ['192.168.1.100', '10.0.0.50', '172.16.0.25', '203.0.113.10'];
                const types = ['XSS攻击', 'SQL注入', 'CSRF攻击', '垃圾评论', '暴力破解'];
                
                for (let i = 0; i < Math.floor(Math.random() * 8) + 2; i++) {
                    const score = Math.floor(Math.random() * 100);
                    threats.push({
                        ip: ips[Math.floor(Math.random() * ips.length)],
                        type: types[Math.floor(Math.random() * types.length)],
                        score: score,
                        severity: score > 80 ? 'critical' : score > 60 ? 'high' : 'medium',
                        timestamp: new Date(Date.now() - Math.random() * 3600000).toISOString(),
                        blocked: Math.random() > 0.5
                    });
                }
                
                return threats.sort((a, b) => b.score - a.score);
            }

            // 生成模拟日志数据
            generateMockLogs() {
                const logs = [];
                const events = [
                    { level: 'info', message: '用户登录成功' },
                    { level: 'warn', message: '检测到异常请求频率' },
                    { level: 'error', message: 'XSS攻击尝试被阻止' },
                    { level: 'info', message: '安全备份创建完成' },
                    { level: 'warn', message: '可疑IP被标记' },
                    { level: 'error', message: 'SQL注入攻击被拦截' }
                ];
                
                for (let i = 0; i < 10; i++) {
                    const event = events[Math.floor(Math.random() * events.length)];
                    logs.push({
                        timestamp: new Date(Date.now() - i * 60000).toISOString(),
                        level: event.level,
                        message: event.message
                    });
                }
                
                return logs;
            }

            // 更新面板显示
            updateDashboard() {
                // 更新统计数据
                document.getElementById('totalRequests').textContent = this.securityData.totalRequests.toLocaleString();
                document.getElementById('blockedThreats').textContent = this.securityData.blockedThreats;
                document.getElementById('suspiciousIPs').textContent = this.securityData.suspiciousIPs;
                document.getElementById('systemHealth').textContent = this.securityData.systemHealth + '%';

                // 更新风险等级
                const riskElement = document.getElementById('riskLevel');
                const riskMap = {
                    'MINIMAL': { text: '风险等级: 极低', class: 'risk-minimal' },
                    'LOW': { text: '风险等级: 低', class: 'risk-low' },
                    'MEDIUM': { text: '风险等级: 中', class: 'risk-medium' },
                    'HIGH': { text: '风险等级: 高', class: 'risk-high' }
                };
                
                const risk = riskMap[this.securityData.riskLevel];
                riskElement.textContent = risk.text;
                riskElement.className = 'risk-indicator ' + risk.class;

                // 更新威胁列表
                this.updateThreatList();
                
                // 更新活动日志
                this.updateActivityLog();
                
                // 更新系统状态
                this.updateSystemStatus();
            }

            // 更新威胁列表
            updateThreatList() {
                this.loadAttackersData();
            }

            // 加载攻击者数据
            async loadAttackersData() {
                try {
                    const response = await fetch('/api/security/attackers');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.displayAttackers(result.data);
                    } else {
                        console.error('加载攻击者数据失败:', result.error);
                        this.displayMockThreats();
                    }
                } catch (error) {
                    console.error('加载攻击者数据失败:', error);
                    this.displayMockThreats();
                }
            }

            // 显示攻击者信息
            displayAttackers(attackers) {
                const threatList = document.getElementById('threatList');
                
                if (attackers.length === 0) {
                    threatList.innerHTML = '<p style="text-align: center; color: #27ae60; padding: 40px;">🎉 当前无活跃威胁</p>';
                    return;
                }
                
                const attackersHtml = attackers.slice(0, 10).map(attacker => `
                    <div class="threat-item ${attacker.threatLevel.toLowerCase()}">
                        <div>
                            <span class="threat-ip">${attacker.ip}</span>
                            <span class="threat-score ${attacker.threatLevel.toLowerCase()}">${attacker.attackCount}</span>
                            ${attacker.geoLocation ? `<span style="font-size: 0.8em; color: #666; margin-left: 10px;">📍 ${attacker.geoLocation.country}</span>` : ''}
                        </div>
                        <div class="threat-details">
                            <strong>威胁等级: ${attacker.threatLevel}</strong> - 
                            攻击类型: ${Array.from(attacker.attackTypes).join(', ')} - 
                            ${attacker.isBlocked ? '🚫 已封锁' : '👁️ 监控中'} - 
                            最后活动: ${new Date(attacker.lastSeen).toLocaleString()}
                        </div>
                        <div class="threat-details" style="margin-top: 5px; font-size: 0.85em;">
                            首次发现: ${new Date(attacker.firstSeen).toLocaleString()} | 
                            蜜罐命中: ${attacker.honeypotHits}次 | 
                            证据: ${attacker.evidence.length}条
                        </div>
                        <div style="margin-top: 10px;">
                            ${!attacker.isBlocked ? `
                                <button class="control-btn danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="blockIP('${attacker.ip}')">
                                    🚫 封锁IP
                                </button>
                            ` : `
                                <button class="control-btn success" style="padding: 5px 10px; font-size: 0.8em;" onclick="unblockIP('${attacker.ip}')">
                                    ✅ 解除封锁
                                </button>
                            `}
                            <button class="control-btn primary" style="padding: 5px 10px; font-size: 0.8em;" onclick="viewAttackerDetails('${attacker.ip}')">
                                📋 详细信息
                            </button>
                            <button class="control-btn warning" style="padding: 5px 10px; font-size: 0.8em;" onclick="viewEvidence('${attacker.ip}')">
                                🔍 查看证据
                            </button>
                        </div>
                    </div>
                `).join('');
                
                threatList.innerHTML = attackersHtml;
            }

            // 显示模拟威胁（备用）
            displayMockThreats() {
                const threatList = document.getElementById('threatList');
                
                if (this.securityData.threats.length === 0) {
                    threatList.innerHTML = '<p style="text-align: center; color: #27ae60; padding: 40px;">🎉 当前无活跃威胁</p>';
                    return;
                }
                
                const threatsHtml = this.securityData.threats.map(threat => `
                    <div class="threat-item ${threat.severity}">
                        <div>
                            <span class="threat-ip">${threat.ip}</span>
                            <span class="threat-score ${threat.severity}">${threat.score}</span>
                        </div>
                        <div class="threat-details">
                            <strong>${threat.type}</strong> - 
                            ${threat.blocked ? '已阻止' : '监控中'} - 
                            ${new Date(threat.timestamp).toLocaleTimeString()}
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="control-btn danger" style="padding: 5px 10px; font-size: 0.8em;" onclick="blockIP('${threat.ip}')">
                                🚫 封锁IP
                            </button>
                            <button class="control-btn primary" style="padding: 5px 10px; font-size: 0.8em;" onclick="viewThreatDetails('${threat.ip}')">
                                📋 详情
                            </button>
                        </div>
                    </div>
                `).join('');
                
                threatList.innerHTML = threatsHtml;
            }

            // 更新活动日志
            updateActivityLog() {
                const activityLog = document.getElementById('activityLog');
                
                const logsHtml = this.securityData.logs.map(log => `
                    <div class="log-entry ${log.level}">
                        <span class="log-timestamp">[${new Date(log.timestamp).toLocaleString()}]</span>
                        <span>${log.level.toUpperCase()}: ${log.message}</span>
                    </div>
                `).join('');
                
                activityLog.innerHTML = logsHtml;
                
                // 自动滚动到底部
                activityLog.scrollTop = activityLog.scrollHeight;
            }

            // 更新系统状态
            updateSystemStatus() {
                const statusElement = document.getElementById('systemStatus');
                const health = this.securityData.systemHealth;
                
                if (health >= 95) {
                    statusElement.className = 'status-indicator status-online';
                } else if (health >= 80) {
                    statusElement.className = 'status-indicator status-warning';
                } else {
                    statusElement.className = 'status-indicator status-offline';
                }
            }

            // 开始实时更新
            startRealTimeUpdates() {
                setInterval(() => {
                    this.loadSecurityData();
                }, this.updateInterval);
            }

            // 设置事件监听器
            setupEventListeners() {
                // 页面可见性变化时暂停/恢复更新
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        console.log('⏸️ 面板更新已暂停');
                    } else {
                        console.log('▶️ 面板更新已恢复');
                        this.loadSecurityData();
                    }
                });
            }

            // 显示告警
            showAlert(message, type = 'error') {
                const alertBanner = document.getElementById('alertBanner');
                const alertMessage = document.getElementById('alertMessage');
                
                alertMessage.textContent = message;
                alertBanner.className = 'alert-banner show';
                
                // 5秒后自动隐藏
                setTimeout(() => {
                    alertBanner.className = 'alert-banner';
                }, 5000);
            }
        }

        // 初始化安全面板
        let securityDashboard;
        document.addEventListener('DOMContentLoaded', () => {
            securityDashboard = new SecurityDashboard();
        });

        // 全局函数
        function toggleConfig(configName) {
            const toggles = document.querySelectorAll('.toggle-switch');
            // 这里应该实现真实的配置切换逻辑
            console.log(`切换配置: ${configName}`);
        }

        async function blockIP(ip) {
            if (confirm(`确定要封锁IP地址 ${ip} 吗？`)) {
                try {
                    const response = await fetch('/api/security/block-ip', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ip: ip,
                            reason: '管理员手动封锁'
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        securityDashboard.showAlert(`IP ${ip} 已被封锁`, 'success');
                        securityDashboard.loadSecurityData(); // 刷新数据
                    } else {
                        securityDashboard.showAlert(`封锁失败: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('封锁IP失败:', error);
                    securityDashboard.showAlert('封锁操作失败', 'error');
                }
            }
        }

        async function unblockIP(ip) {
            if (confirm(`确定要解除封锁IP地址 ${ip} 吗？`)) {
                try {
                    const response = await fetch('/api/security/unblock-ip', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ ip: ip })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        securityDashboard.showAlert(`IP ${ip} 已解除封锁`, 'success');
                        securityDashboard.loadSecurityData(); // 刷新数据
                    } else {
                        securityDashboard.showAlert(`解除封锁失败: ${result.error}`, 'error');
                    }
                } catch (error) {
                    console.error('解除封锁失败:', error);
                    securityDashboard.showAlert('解除封锁操作失败', 'error');
                }
            }
        }

        async function viewAttackerDetails(ip) {
            try {
                const response = await fetch(`/api/security/attacker/${ip}`);
                const result = await response.json();
                
                if (result.success) {
                    const attacker = result.data;
                    const detailsHtml = `
                        <div style="max-width: 600px; max-height: 500px; overflow-y: auto;">
                            <h3>🕵️ 攻击者详细信息</h3>
                            <p><strong>IP地址:</strong> ${attacker.ip}</p>
                            <p><strong>威胁等级:</strong> <span style="color: ${getThreatColor(attacker.threatLevel)}">${attacker.threatLevel}</span></p>
                            <p><strong>攻击次数:</strong> ${attacker.attackCount}</p>
                            <p><strong>首次发现:</strong> ${new Date(attacker.firstSeen).toLocaleString()}</p>
                            <p><strong>最后活动:</strong> ${new Date(attacker.lastSeen).toLocaleString()}</p>
                            <p><strong>蜜罐命中:</strong> ${attacker.honeypotHits}次</p>
                            <p><strong>封锁状态:</strong> ${attacker.isBlocked ? '🚫 已封锁' : '👁️ 监控中'}</p>
                            
                            ${attacker.geoLocation ? `
                                <h4>📍 地理位置信息</h4>
                                <p><strong>国家:</strong> ${attacker.geoLocation.country}</p>
                                <p><strong>城市:</strong> ${attacker.geoLocation.city}</p>
                                <p><strong>ISP:</strong> ${attacker.geoLocation.isp}</p>
                                <p><strong>组织:</strong> ${attacker.geoLocation.org}</p>
                            ` : ''}
                            
                            <h4>🎯 攻击类型</h4>
                            <p>${Array.from(attacker.attackTypes).join(', ')}</p>
                            
                            <h4>🖥️ 用户代理</h4>
                            <div style="max-height: 100px; overflow-y: auto; font-size: 0.8em; background: #f5f5f5; padding: 10px;">
                                ${Array.from(attacker.userAgents).map(ua => `<p>${ua}</p>`).join('')}
                            </div>
                            
                            <h4>🔗 访问路径</h4>
                            <div style="max-height: 100px; overflow-y: auto; font-size: 0.8em; background: #f5f5f5; padding: 10px;">
                                ${Array.from(attacker.requestedPaths).map(path => `<p>${path}</p>`).join('')}
                            </div>
                        </div>
                    `;
                    
                    showModal('攻击者详情', detailsHtml);
                } else {
                    securityDashboard.showAlert('获取攻击者详情失败', 'error');
                }
            } catch (error) {
                console.error('获取攻击者详情失败:', error);
                securityDashboard.showAlert('获取攻击者详情失败', 'error');
            }
        }

        function viewEvidence(ip) {
            // 显示证据详情
            showModal('证据详情', `
                <div>
                    <h3>📋 攻击证据</h3>
                    <p>正在加载IP ${ip} 的攻击证据...</p>
                    <p>此功能将显示:</p>
                    <ul>
                        <li>攻击载荷和模式</li>
                        <li>请求头和参数</li>
                        <li>时间戳和频率分析</li>
                        <li>数字指纹信息</li>
                        <li>法律证据报告</li>
                    </ul>
                </div>
            `);
        }

        function getThreatColor(level) {
            const colors = {
                'CRITICAL': '#e74c3c',
                'HIGH': '#f39c12',
                'MEDIUM': '#f1c40f',
                'LOW': '#27ae60'
            };
            return colors[level] || '#666';
        }

        function showModal(title, content) {
            // 创建模态框
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 20px;
                    border-radius: 10px;
                    max-width: 80%;
                    max-height: 80%;
                    overflow-y: auto;
                    position: relative;
                ">
                    <button onclick="this.closest('.modal').remove()" style="
                        position: absolute;
                        top: 10px;
                        right: 15px;
                        background: none;
                        border: none;
                        font-size: 20px;
                        cursor: pointer;
                        color: #666;
                    ">&times;</button>
                    <h2>${title}</h2>
                    ${content}
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function viewThreatDetails(ip) {
            viewAttackerDetails(ip);
        }

        function blockAllSuspicious() {
            if (confirm('确定要封锁所有可疑IP吗？这是一个危险操作！')) {
                console.log('封锁所有可疑IP');
                securityDashboard.showAlert('所有可疑IP已被封锁', 'success');
            }
        }

        function refreshThreats() {
            console.log('刷新威胁列表');
            securityDashboard.loadSecurityData();
        }

        function exportThreatReport() {
            console.log('导出威胁报告');
            securityDashboard.showAlert('威胁报告导出功能开发中', 'info');
        }

        function saveConfig() {
            console.log('保存配置');
            securityDashboard.showAlert('配置已保存', 'success');
        }

        function resetConfig() {
            if (confirm('确定要重置所有配置吗？')) {
                console.log('重置配置');
                securityDashboard.showAlert('配置已重置', 'success');
            }
        }

        function clearLogs() {
            if (confirm('确定要清空所有日志吗？')) {
                document.getElementById('activityLog').innerHTML = '<div class="log-entry info"><span class="log-timestamp">[' + new Date().toLocaleString() + ']</span> <span>INFO: 日志已清空</span></div>';
            }
        }

        function exportLogs() {
            console.log('导出日志');
            securityDashboard.showAlert('日志导出功能开发中', 'info');
        }

        function generateReport() {
            console.log('生成报告');
            securityDashboard.showAlert('报告生成功能开发中', 'info');
        }

        function scheduleReport() {
            console.log('定时报告');
            securityDashboard.showAlert('定时报告功能开发中', 'info');
        }

        function runSecurityScan() {
            console.log('执行安全扫描');
            securityDashboard.showAlert('安全扫描已启动', 'info');
        }

        function createBackup() {
            console.log('创建安全备份');
            securityDashboard.showAlert('安全备份已创建', 'success');
        }

        function testSecurity() {
            console.log('安全测试');
            securityDashboard.showAlert('安全测试已启动', 'info');
        }

        function emergencyLockdown() {
            if (confirm('确定要启动紧急锁定吗？这将阻止所有访问！')) {
                console.log('紧急锁定');
                securityDashboard.showAlert('紧急锁定已激活', 'error');
            }
        }
    </script>
</body>
</html> 