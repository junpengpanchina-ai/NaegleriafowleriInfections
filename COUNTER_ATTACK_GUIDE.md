# 🕵️ 反攻击监控系统使用指南

## 📋 概述

反攻击监控系统是一个高级的网络安全防护工具，专门用于检测、追踪、记录和反制网络攻击行为。当系统检测到攻击时，会自动收集攻击者信息、地理位置、攻击模式等详细数据，并采取相应的反制措施。

## 🎯 核心功能

### 1. 攻击者追踪
- **IP地址监控**: 实时追踪攻击者IP地址
- **地理位置定位**: 自动获取攻击者地理位置信息
- **数字指纹识别**: 生成唯一的攻击者数字指纹
- **行为模式分析**: 分析攻击者的行为模式和习惯

### 2. 攻击检测
- **XSS攻击检测**: 检测跨站脚本攻击尝试
- **SQL注入检测**: 识别SQL注入攻击模式
- **目录遍历检测**: 发现路径遍历攻击
- **命令注入检测**: 检测命令注入尝试
- **扫描行为识别**: 识别自动化扫描工具
- **蜜罐陷阱**: 设置诱饵路径捕获攻击者

### 3. 证据收集
- **完整请求记录**: 记录攻击请求的所有细节
- **时间戳记录**: 精确记录攻击时间
- **载荷分析**: 分析攻击载荷和模式
- **法律证据生成**: 生成可用于法律诉讼的证据报告

### 4. 反制措施
- **自动IP封锁**: 自动封锁恶意IP地址
- **蜜罐重定向**: 将攻击者重定向到蜜罐系统
- **资源限制**: 限制攻击者的资源访问
- **法律警告**: 向攻击者发送法律警告

## 🚀 快速开始

### 1. 系统启动
反攻击监控系统会在服务器启动时自动初始化：

```bash
npm start
```

系统启动后会显示：
```
🕵️  反攻击监控系统已启动
📋 已加载 X 个攻击者记录
🍯 蜜罐陷阱已设置
🌍 地理位置服务已启用
```

### 2. 访问管理面板
通过以下方式访问反攻击监控管理界面：

- **安全管理面板**: `http://localhost:3000/security-dashboard.html`
- **实时威胁监控**: 在面板中查看"实时威胁监控"部分

### 3. 查看攻击者信息
```bash
# 查看所有攻击者
npm run security:attackers

# 生成攻击报告
npm run security:counter-attack
```

## 🔍 攻击检测机制

### 自动检测触发条件

1. **XSS攻击检测**
   ```javascript
   // 检测模式
   /<script[^>]*>.*?<\/script>/gi
   /javascript:/gi
   /on\w+\s*=\s*["'][^"']*["']/gi
   ```

2. **SQL注入检测**
   ```javascript
   // 检测模式
   /(union|select|insert|update|delete)/gi
   /(\s|^)(or|and)\s+\d+\s*=\s*\d+/gi
   /['";]\s*(or|and)\s+['"]?\w+['"]?\s*=/gi
   ```

3. **目录遍历检测**
   ```javascript
   // 检测模式
   /\.\.[\/\\]/g
   /\.\.%2f/gi
   /%2e%2e%2f/gi
   ```

4. **蜜罐路径**
   ```
   /admin/login.php
   /wp-admin/admin.php
   /phpmyadmin/index.php
   /.env
   /config.php
   /backup.sql
   ```

### 威胁等级评估

系统根据以下因素计算威胁等级：

- **攻击次数**: 每次攻击 +2分
- **攻击类型**: SQL注入(+20), XSS(+15), 命令注入(+25)
- **蜜罐命中**: 每次命中 +10分
- **时间频率**: 短时间内多次攻击 +20分

威胁等级分类：
- **CRITICAL** (80+分): 严重威胁，立即封锁
- **HIGH** (60-79分): 高危威胁，重点监控
- **MEDIUM** (40-59分): 中等威胁，持续观察
- **LOW** (0-39分): 低级威胁，记录备案

## 🛡️ 反制措施

### 自动反制

1. **IP封锁**
   - 触发条件：攻击次数 ≥ 3次 或 威胁等级 = CRITICAL
   - 封锁时长：24小时（可配置）
   - 封锁方式：应用层拦截 + 防火墙规则

2. **蜜罐重定向**
   - 触发条件：攻击次数 ≥ 2次 且 威胁等级 ≠ LOW
   - 重定向目标：虚假管理界面或诱饵内容

3. **资源限制**
   - 触发条件：威胁等级 = HIGH 或 CRITICAL
   - 限制内容：带宽限制、请求频率限制

4. **法律警告**
   - 触发条件：攻击次数 > 5次
   - 警告内容：法律条文、违法后果、证据记录

### 手动反制

通过安全管理面板可以执行：

1. **手动封锁IP**
   ```javascript
   // API调用
   POST /api/security/block-ip
   {
     "ip": "192.168.1.100",
     "reason": "恶意攻击行为"
   }
   ```

2. **解除IP封锁**
   ```javascript
   // API调用
   POST /api/security/unblock-ip
   {
     "ip": "192.168.1.100"
   }
   ```

## 📊 数据分析

### 攻击者档案

每个攻击者的完整档案包括：

```json
{
  "ip": "192.168.1.100",
  "firstSeen": "2025-01-21T10:30:00.000Z",
  "lastSeen": "2025-01-21T11:45:00.000Z",
  "attackCount": 15,
  "attackTypes": ["xss_attack", "sql_injection"],
  "threatLevel": "HIGH",
  "isBlocked": true,
  "geoLocation": {
    "country": "China",
    "city": "Beijing",
    "isp": "China Telecom",
    "coordinates": [39.9042, 116.4074]
  },
  "fingerprint": "sha256_hash",
  "evidence": [...],
  "honeypotHits": 3
}
```

### 地理位置分析

系统自动获取攻击者地理位置信息：

- **国家和城市**: 精确到城市级别
- **ISP信息**: 互联网服务提供商
- **坐标位置**: GPS坐标（如可用）
- **代理检测**: 识别是否使用代理/VPN

### 攻击模式分析

- **时间分布**: 攻击活动的时间模式
- **频率分析**: 攻击频率和间隔
- **载荷分析**: 攻击载荷的特征和变化
- **工具识别**: 识别使用的攻击工具

## 📋 证据管理

### 证据收集

系统自动收集以下证据：

1. **请求详情**
   - HTTP方法、URL、参数
   - 请求头信息
   - POST数据内容

2. **攻击载荷**
   - 具体的攻击代码
   - 攻击模式匹配结果
   - 危险程度评估

3. **环境信息**
   - 时间戳（精确到毫秒）
   - 客户端IP和端口
   - 用户代理字符串
   - 来源页面信息

4. **响应记录**
   - 系统响应内容
   - 采取的防护措施
   - 封锁状态和时长

### 证据存储

证据存储在加密文件中：

```
./security/evidence/
├── 2025-01-21/
│   ├── 192.168.1.100_1642781234567_abc123.json
│   ├── 192.168.1.100_1642781234567_abc123_report.txt
│   └── ...
└── 2025-01-22/
    └── ...
```

### 法律报告生成

系统自动生成法律证据报告：

```
=== 网络攻击证据报告 ===
报告ID: 192.168.1.100_1642781234567_abc123
时间: 2025-01-21T10:30:15.123Z
攻击者IP: 192.168.1.100
攻击类型: SQL注入攻击
严重程度: CRITICAL

=== 攻击详情 ===
[详细的攻击信息和证据]

=== 法律声明 ===
此报告记录了对本系统的未授权访问尝试。
根据相关法律法规，此行为可能构成违法犯罪。
本报告可作为法律诉讼的证据使用。
```

## 🔧 配置选项

### 基本配置

```javascript
// counter-attack-monitor.js 中的配置
const config = {
  // 自动封锁
  autoBlock: true,
  blockDuration: 24 * 60 * 60 * 1000, // 24小时
  
  // 蜜罐重定向
  honeypotRedirect: true,
  
  // 证据收集
  evidenceCollection: true,
  
  // 地理位置查询
  geoLocationEnabled: true,
  
  // 法律警告
  legalNotification: true
};
```

### 攻击检测阈值

```javascript
// 检测阈值配置
const thresholds = {
  maxAttemptsBeforeBlock: 3,
  criticalThreatScore: 80,
  honeypotTolerance: 0, // 零容忍
  scanningDetectionLimit: 50 // 1分钟内50个请求
};
```

## 📈 监控和报告

### 实时监控

1. **安全管理面板**
   - 实时威胁列表
   - 攻击统计图表
   - 地理分布地图
   - 系统状态监控

2. **API接口**
   ```bash
   # 获取攻击者列表
   GET /api/security/attackers
   
   # 获取特定攻击者信息
   GET /api/security/attacker/{ip}
   
   # 获取安全统计
   GET /api/security/statistics
   ```

### 定期报告

系统每6小时自动生成攻击报告：

```bash
# 手动生成报告
npm run security:counter-attack
```

报告内容包括：
- 攻击概况统计
- Top 10 攻击者
- 地理分布分析
- 攻击类型统计
- 安全建议

## 🚨 告警通知

### 告警触发条件

1. **严重威胁检测**: 威胁等级达到CRITICAL
2. **大规模攻击**: 1小时内攻击次数超过100次
3. **新型攻击**: 检测到未知攻击模式
4. **蜜罐命中**: 任何蜜罐路径被访问
5. **系统异常**: 反攻击系统出现异常

### 告警方式

- **控制台日志**: 实时显示攻击事件
- **安全面板**: 弹窗告警通知
- **邮件通知**: 发送到管理员邮箱（需配置）
- **短信告警**: 紧急情况短信通知（需配置）

## 🔒 隐私和合规

### 数据保护

1. **数据加密**: 所有敏感数据均加密存储
2. **访问控制**: 严格的访问权限控制
3. **数据脱敏**: 日志中的敏感信息脱敏处理
4. **定期清理**: 自动清理过期数据（30天）

### 法律合规

1. **证据有效性**: 确保收集的证据具有法律效力
2. **隐私保护**: 遵守数据保护法规
3. **透明度**: 提供攻击者权利救济渠道
4. **审计跟踪**: 完整的操作审计日志

## 🛠️ 故障排除

### 常见问题

1. **地理位置查询失败**
   ```bash
   # 检查网络连接
   curl -I http://ip-api.com
   
   # 检查API配额
   # 免费版本每分钟限制45次查询
   ```

2. **证据文件写入失败**
   ```bash
   # 检查目录权限
   ls -la ./security/evidence/
   
   # 创建缺失目录
   mkdir -p ./security/evidence
   chmod 700 ./security/evidence
   ```

3. **攻击检测不准确**
   ```javascript
   // 调整检测模式和阈值
   // 在 counter-attack-monitor.js 中修改 attackPatterns
   ```

### 调试模式

启用详细日志记录：

```bash
# 设置环境变量
export DEBUG_COUNTER_ATTACK=true

# 启动服务器
npm start
```

## 📞 技术支持

### 联系方式

- **技术支持**: tech-support@cdc.gov
- **安全事件**: security-incident@cdc.gov
- **紧急热线**: +1-800-CDC-INFO

### 文档资源

- **API文档**: 详见代码注释
- **配置指南**: 本文档
- **最佳实践**: `SECURITY.md`
- **部署指南**: `DEPLOYMENT.md`

---

**文档版本**: 1.0  
**创建日期**: 2025年1月21日  
**维护者**: CDC安全团队  
**下次更新**: 2025年4月21日 